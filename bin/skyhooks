#!/usr/bin/env ruby
# skyhooks

# 20210604
# 0.1.0

require 'Array/match'
require 'File/self.gsubX'

RAILS_EXCLUSIONS = [
  /spec_helper/,
  /helpers/,
  /factories/,
  /support/
]

def dir?
  @dirQ
end

def dir_or_file
  dir_or_file = File.expand_path(ARGV[0]) || '.'
  @dirQ = File.directory?(dir_or_file)
  dir_or_file
end

def test_filenames
  if dir?
    Dir.glob("#{dir_or_file}/**/*.rb").select do |filename|
      RAILS_EXCLUSIONS.match(filename).empty?
    end
  else
    [dir_or_file]
  end
end

def main
  test_filenames.each do |test_filename|
    File.gsub!(test_filename, /FactoryBot\.create/, 'FactoryBot.build')
    system("rspec #{test_filename}")
    next if $?.exitstatus.zero?
    system("git checkout #{test_filename}")
  end
end

main
